{% extends "base.html" %}

{% block title %}Employee Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Duration Box */
.duration-box {
    margin-top: 15px;
    padding: 14px 18px;
    border-radius: 12px;
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    border: 1px solid #c8e6c9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

.duration-label {
    color: #2e7d32;
    font-size: 14px;
}

.duration-value {
    font-size: 20px;
    color: #1b5e20;
}

/* Dashboard layout */
.dashboard-wrapper {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
}

/* Form container */
.form-container {
    flex: 1 1 400px;
    min-width: 300px;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

/* Entitlements Cards */
.entitlements {
    flex: 1 1 400px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Entitlement card */
.entitlement-card {
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

/* Header */
.entitlement-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

/* Badges */
.badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.badge.success {
    background: #e8f5e9;
    color: #2e7d32;
}

.badge.warning {
    background: #fff8e1;
    color: #f57f17;
}

.badge.danger {
    background: #fdecea;
    color: #c62828;
}

/* Stats */
.entitlement-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.stat {
    text-align: center;
    flex: 1;
}

.stat .label {
    font-size: 13px;
    color: #6c757d;
}

.stat .value {
    font-size: 16px;
    font-weight: 600;
}

.stat.highlight .value {
    color: #1b5e20;
}

/* Progress bar */
.progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #81c784);
    width: 0;
    transition: width 0.4s ease;
}
</style>
{% endblock %}

{% block content %}

<!-- Welcome Card -->
<div class="welcome-card">
    <h2>Welcome, {{ user.username }} ðŸ‘‹</h2>
    <p>Submit leave requests, track approvals, and manage your leave calendar.</p>
</div>

<!-- Main dashboard wrapper -->
<div class="dashboard-wrapper">

    <!-- Apply Leave Form -->
    <div class="form-container" id="apply-leave">
        <h3>Apply for Leave</h3>
        <form method="POST" action="{% url 'leave_request' %}">
            {% csrf_token %}
            <label>Leave Type</label>
            <select name="leave_type" required>
                <option value="">Select Leave Type</option>
                <option value="Vacation">Vacation</option>
                <option value="Sick Leave">Sick Leave</option>
                <option value="Work From Home">Work From Home</option>
            </select>

            <label>Start Date</label>
            <input type="date" name="start_date" id="start_date" required>

            <label>End Date</label>
            <input type="date" name="end_date" id="end_date" required>

            <div class="duration-box">
                <span class="duration-label">Leave Duration (Excl. Holidays)</span>
                <span class="duration-value"><span id="duration">0</span> day(s)</span>
            </div>

            <label>Reason</label>
            <textarea name="reason" rows="4" placeholder="Enter reason for leave" required></textarea>

            {% if user.userprofile.manager %}
            <div class="duration-box" style="margin-top:10px; background:#e3f2fd; border:1px solid #90caf9;">
                <span class="duration-label">Manager</span>
                <span class="duration-value">{{ user.userprofile.manager.username }}</span>
            </div>
            {% endif %}

            <button type="submit">Submit Leave Request</button>
        </form>
    </div>

    <!-- Entitlements Cards -->
    <div class="entitlements">
        {% for e in entitlements %}
        <div class="entitlement-card">
            <div class="entitlement-header">
                <h4>{{ e.type }}</h4>
                {% if e.remaining <= 0 %}
                    <span class="badge danger">No Balance</span>
                {% elif e.remaining <= 2 %}
                    <span class="badge warning">Low</span>
                {% else %}
                    <span class="badge success">Available</span>
                {% endif %}
            </div>

            <div class="entitlement-stats">
                <div class="stat">
                    <div class="label">Total</div>
                    <div class="value">{{ e.total }} days</div>
                </div>
                <div class="stat">
                    <div class="label">Used</div>
                    <div class="value">{{ e.applied }} days</div>
                </div>
                <div class="stat highlight">
                    <div class="label">Remaining</div>
                    <div class="value">{{ e.remaining }} days</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress" data-width="{{ e.used_percent }}"></div>
            </div>
        </div>
        {% empty %}
        <p>No entitlements found.</p>
        {% endfor %}
    </div>

</div>

<!-- Pass holidays safely to JS -->
{{ holiday_dates|json_script:"holiday-data" }}

{% endblock %}

{% block extra_js %}
<script>
const startDateInput = document.getElementById("start_date");
const endDateInput = document.getElementById("end_date");
const durationSpan = document.getElementById("duration");

// Parse holidays safely
const holidayDates = JSON.parse(document.getElementById('holiday-data').textContent);

function calculateDuration() {
    if (!startDateInput.value || !endDateInput.value) {
        durationSpan.textContent = 0;
        return;
    }

    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    if (endDate < startDate) {
        durationSpan.textContent = 0;
        return;
    }

    let count = 0;
    let current = new Date(startDate);

    while (current <= endDate) {
        const iso = current.toISOString().split("T")[0]; // format 'YYYY-MM-DD'
        if (!holidayDates.includes(iso)) {
            count++;  // count only if not a holiday
        }
        current.setDate(current.getDate() + 1);
    }

    durationSpan.textContent = count;
}

startDateInput.addEventListener("change", () => {
    endDateInput.min = startDateInput.value;
    if (endDateInput.value && endDateInput.value < startDateInput.value) {
        endDateInput.value = "";
        durationSpan.textContent = 0;
    }
    calculateDuration();
});

endDateInput.addEventListener("change", calculateDuration);
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".progress").forEach(bar => {
        const width = bar.getAttribute("data-width");
        bar.style.width = width + "%";
    });
});
</script>

{% endblock %}
